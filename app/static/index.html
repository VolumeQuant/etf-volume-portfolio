<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>VolumeQuant - ETF Volume Lab</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    h1 {
      color: white;
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    .subtitle {
      color: rgba(255,255,255,0.9);
      font-size: 1.1rem;
      margin-bottom: 30px;
    }
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
    }
    .card h3 {
      color: #333;
      font-size: 1.3rem;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .badge.extreme { background: #ff4444; color: white; }
    .badge.high { background: #ff8800; color: white; }
    .badge.medium { background: #ffbb00; color: white; }
    .badge.alert { background: #44ccff; color: white; }
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-group {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #555;
    }
    tr:hover {
      background: #f8f9fa;
    }
    .stat {
      font-size: 2rem;
      font-weight: 700;
      color: #667eea;
      margin: 10px 0;
    }
    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 20px;
    }
    pre {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 10px;
      overflow: auto;
      font-size: 0.9rem;
      max-height: 400px;
    }
    .event-item {
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 4px solid #667eea;
    }
    .event-item strong {
      color: #667eea;
    }
    .timestamp {
      color: #999;
      font-size: 0.85rem;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“Š VolumeQuant</h1>
    <p class="subtitle">ETF ê±°ë˜ëŸ‰ ì´ìƒì§•í›„ íƒì§€ & ë¶„ì„ ì‹œìŠ¤í…œ</p>

    <div class="btn-group">
      <button class="btn" id="btnQuickScan">ğŸš€ ë¹ ë¥¸ ìŠ¤ìº” (5ì¼)</button>
      <button class="btn" id="btnFullAnalysis">ğŸ” ì „ì²´ ë¶„ì„ (1ë…„)</button>
      <button class="btn" id="btnRefresh">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    </div>

    <div class="dashboard">
      <!-- ìš”ì•½ í†µê³„ -->
      <div class="card">
        <h3>ğŸ“ˆ ì´ë²¤íŠ¸ ìš”ì•½</h3>
        <div id="summaryStats">
          <div class="loading">
            <div class="spinner"></div>
            <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
          </div>
        </div>
      </div>

      <!-- ìµœê·¼ ì´ë²¤íŠ¸ -->
      <div class="card">
        <h3>âš¡ ìµœê·¼ ì´ë²¤íŠ¸</h3>
        <div id="recentEvents">
          <p style="color: #999;">ë¶„ì„ì„ ì‹œì‘í•˜ë ¤ë©´ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
        </div>
      </div>

      <!-- Top Spikes -->
      <div class="card">
        <h3>ğŸ”¥ ìµœëŒ€ ê±°ë˜ëŸ‰ ìŠ¤íŒŒì´í¬</h3>
        <div id="topSpikes">
          <p style="color: #999;">ë¶„ì„ì„ ì‹œì‘í•˜ë ¤ë©´ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
        </div>
      </div>
    </div>

    <!-- ì°¨íŠ¸ ì˜ì—­ -->
    <div class="card" style="margin-bottom: 20px;">
      <h3>ğŸ“Š ê±°ë˜ëŸ‰ ìŠ¤íŒŒì´í¬ ë¶„í¬</h3>
      <div class="chart-container">
        <canvas id="spikeChart"></canvas>
      </div>
    </div>

    <!-- ìƒì„¸ ë°ì´í„° -->
    <div class="card">
      <h3>ğŸ”¬ ìƒì„¸ ë¶„ì„ ë°ì´í„°</h3>
      <pre id="rawData">ë¶„ì„ì„ ì‹œì‘í•˜ë ¤ë©´ ìœ„ì˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</pre>
    </div>

    <!-- AI ì„¤ëª… -->
    <div class="card">
      <h3>ğŸ¤– AI ì¸ì‚¬ì´íŠ¸</h3>
      <button class="btn" id="btnExplain">AI ì„¤ëª… ìƒì„±</button>
      <div id="explainView" style="margin-top: 16px;">
        <p style="color: #999;">ë¶„ì„ í›„ AI ì„¤ëª…ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      </div>
    </div>
  </div>

  <script>
    let currentData = null;
    let spikeChart = null;

    // ë¹ ë¥¸ ìŠ¤ìº”
    document.getElementById('btnQuickScan').onclick = async () => {
      await runAnalysis('/api/analysis/quick', 'quick');
    };

    // ì „ì²´ ë¶„ì„
    document.getElementById('btnFullAnalysis').onclick = async () => {
      await runAnalysis('/api/analysis/full', 'full');
    };

    // ìƒˆë¡œê³ ì¹¨
    document.getElementById('btnRefresh').onclick = async () => {
      if (currentData) {
        location.reload();
      } else {
        await runAnalysis('/api/analysis/quick', 'quick');
      }
    };

    // AI ì„¤ëª…
    document.getElementById('btnExplain').onclick = async () => {
      if (!currentData) {
        alert('ë¨¼ì € ë¶„ì„ì„ ì‹¤í–‰í•˜ì„¸ìš”.');
        return;
      }
      
      // ë””ë²„ê¹…: ì–´ë–¤ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ëŠ”ì§€ í™•ì¸
      console.log('AI ì„¤ëª… ìš”ì²­ ë°ì´í„°:', currentData);
      console.log('ë°ì´í„° ëª¨ë“œ:', currentData.mode || 'ì „ì²´ ë¶„ì„');
      
      const explainDiv = document.getElementById('explainView');
      explainDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>AIê°€ ë¶„ì„ ì¤‘...</p></div>';
      
      try {
        const res = await fetch('/api/explain', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ blob: currentData })
        });
        const data = await res.json();
        explainDiv.innerHTML = `<div style="line-height: 1.6; color: #333; white-space: pre-line;">${data.explanation || 'ì„¤ëª…ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}</div>`;
      } catch (err) {
        explainDiv.innerHTML = `<p style="color: #ff4444;">ì˜¤ë¥˜: ${err.message}</p>`;
      }
    };

    // ë¶„ì„ ì‹¤í–‰
    async function runAnalysis(endpoint, mode) {
      const btn = mode === 'quick' ? document.getElementById('btnQuickScan') : document.getElementById('btnFullAnalysis');
      btn.disabled = true;
      btn.textContent = 'ë¶„ì„ ì¤‘...';

      showLoading();

      try {
        const res = await fetch(endpoint);
        
        // ì‘ë‹µì´ JSONì¸ì§€ í™•ì¸
        const contentType = res.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await res.text();
          throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${text.substring(0, 100)}`);
        }
        
        const data = await res.json();
        currentData = data;
        
        // ë””ë²„ê¹…: ë°ì´í„° ì—…ë°ì´íŠ¸ í™•ì¸
        console.log(`${mode} ë¶„ì„ ì™„ë£Œ, currentData ì—…ë°ì´íŠ¸ë¨:`, data);

        if (data.error) {
          throw new Error(data.message);
        }

        // UI ì—…ë°ì´íŠ¸
        updateUI(data, mode);
        
      } catch (err) {
        alert('ë¶„ì„ ì‹¤íŒ¨: ' + err.message);
        console.error(err);
      } finally {
        btn.disabled = false;
        btn.textContent = mode === 'quick' ? 'ğŸš€ ë¹ ë¥¸ ìŠ¤ìº” (5ì¼)' : 'ğŸ” ì „ì²´ ë¶„ì„ (1ë…„)';
      }
    }

    function showLoading() {
      document.getElementById('summaryStats').innerHTML = '<div class="loading"><div class="spinner"></div><p>ë¶„ì„ ì¤‘...</p></div>';
      document.getElementById('recentEvents').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      document.getElementById('topSpikes').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    }

    function updateUI(data, mode) {
      // ì›ë³¸ ë°ì´í„° í‘œì‹œ
      document.getElementById('rawData').textContent = JSON.stringify(data, null, 2);

      if (mode === 'quick') {
        updateQuickScanUI(data);
      } else {
        updateFullAnalysisUI(data);
      }
    }

    function updateQuickScanUI(data) {
      // ìš”ì•½ í†µê³„
      const statsHtml = `
        <div class="stat">${data.data.length}</div>
        <p style="color: #666;">ëª¨ë‹ˆí„°ë§ ì¤‘ì¸ ETF</p>
        <p class="timestamp">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date(data.timestamp).toLocaleString('ko-KR')}</p>
      `;
      document.getElementById('summaryStats').innerHTML = statsHtml;

      // ìµœê·¼ ë°ì´í„°
      let eventsHtml = '';
      data.data.forEach(item => {
        const spikeRatio = item.volume_spike_ratio || 0;
        const badgeClass = spikeRatio >= 2.5 ? 'extreme' : spikeRatio >= 2.0 ? 'high' : spikeRatio >= 1.5 ? 'medium' : 'alert';
        eventsHtml += `
          <div class="event-item">
            <strong>${item.ticker}</strong> <span class="badge ${badgeClass}">${spikeRatio.toFixed(2)}x</span><br>
            <small>${item.name} | $${item.price} (${item.price_change_pct > 0 ? '+' : ''}${item.price_change_pct}%)</small>
          </div>
        `;
      });
      document.getElementById('recentEvents').innerHTML = eventsHtml || '<p style="color: #999;">ì´ë²¤íŠ¸ ì—†ìŒ</p>';
      document.getElementById('topSpikes').innerHTML = '<p style="color: #999;">ì „ì²´ ë¶„ì„ì„ ì‹¤í–‰í•˜ì„¸ìš”.</p>';

      // ì°¨íŠ¸
      updateChart(data.data.map(d => ({ ticker: d.ticker, spike: d.volume_spike_ratio || 1 })));
    }

    function updateFullAnalysisUI(data) {
      // ìš”ì•½ í†µê³„
      const summary = data.summary;
      const statsHtml = `
        <div class="stat">${summary.total_events || 0}</div>
        <p style="color: #666;">ê±°ë˜ëŸ‰ ì´ë²¤íŠ¸ ê°ì§€</p>
        ${summary.by_level ? Object.entries(summary.by_level).map(([level, count]) => 
          `<span class="badge ${level.toLowerCase()}">${level}: ${count}</span>`
        ).join(' ') : ''}
        <p class="timestamp">ê¸°ê°„: ${data.metadata.date_range.start} ~ ${data.metadata.date_range.end}</p>
      `;
      document.getElementById('summaryStats').innerHTML = statsHtml;

      // ìµœê·¼ ì´ë²¤íŠ¸
      let eventsHtml = '';
      if (summary.latest_events && summary.latest_events.length > 0) {
        summary.latest_events.slice(0, 5).forEach(evt => {
          eventsHtml += `
            <div class="event-item">
              <strong>${evt.Ticker}</strong> <span class="badge ${evt.Event_Level.toLowerCase()}">${evt.Event_Level}</span><br>
              <small>${evt.Date} | Spike: ${evt.Volume_Spike_Ratio.toFixed(2)}x | ê°€ê²©: ${evt.Price_Change_Pct > 0 ? '+' : ''}${evt.Price_Change_Pct.toFixed(2)}%</small>
            </div>
          `;
        });
      }
      document.getElementById('recentEvents').innerHTML = eventsHtml || '<p style="color: #999;">ìµœê·¼ ì´ë²¤íŠ¸ ì—†ìŒ</p>';

      // Top Spikes
      let spikesHtml = '<table><tr><th>ë‚ ì§œ</th><th>í‹°ì»¤</th><th>ìŠ¤íŒŒì´í¬</th><th>ê°€ê²©ë³€í™”</th></tr>';
      if (data.top_spikes && data.top_spikes.length > 0) {
        data.top_spikes.slice(0, 5).forEach(spike => {
          spikesHtml += `
            <tr>
              <td>${spike.Date}</td>
              <td><strong>${spike.Ticker}</strong></td>
              <td><span class="badge ${spike.Volume_Spike_Ratio >= 2.5 ? 'extreme' : spike.Volume_Spike_Ratio >= 2.0 ? 'high' : 'medium'}">${spike.Volume_Spike_Ratio.toFixed(2)}x</span></td>
              <td>${spike.Price_Change_Pct > 0 ? '+' : ''}${spike.Price_Change_Pct.toFixed(2)}%</td>
            </tr>
          `;
        });
      }
      spikesHtml += '</table>';
      document.getElementById('topSpikes').innerHTML = spikesHtml;

      // ì°¨íŠ¸
      if (data.top_spikes && data.top_spikes.length > 0) {
        updateChart(data.top_spikes.slice(0, 10).map(d => ({ ticker: d.Ticker, spike: d.Volume_Spike_Ratio })));
      }
    }

    function updateChart(chartData) {
      const ctx = document.getElementById('spikeChart').getContext('2d');
      
      if (spikeChart) {
        spikeChart.destroy();
      }

      spikeChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: chartData.map(d => d.ticker),
          datasets: [{
            label: 'ê±°ë˜ëŸ‰ ìŠ¤íŒŒì´í¬ ë¹„ìœ¨',
            data: chartData.map(d => d.spike),
            backgroundColor: chartData.map(d => {
              if (d.spike >= 2.5) return '#ff4444';
              if (d.spike >= 2.0) return '#ff8800';
              if (d.spike >= 1.5) return '#ffbb00';
              return '#44ccff';
            }),
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'ìŠ¤íŒŒì´í¬ ë¹„ìœ¨ (ë°°ìˆ˜)' }
            }
          }
        }
      });
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ë¹ ë¥¸ ìŠ¤ìº”
    window.onload = () => {
      document.getElementById('btnQuickScan').click();
    };
  </script>
</body>
</html>
